CREATE EXTENSION pg_stat_statements;
CREATE EXTENSION pgsentinel;
select pg_sleep(3);
 pg_sleep 
----------
 
(1 row)

select count(*) > 0 AS has_data from pg_active_session_history where queryid in (select queryid from pg_stat_statements);
 has_data 
----------
 t
(1 row)

begin;
\! sleep 3
commit;
select count(*) > 0 AS has_idle_data from pg_active_session_history where state  = 'idle in transaction';
 has_idle_data 
---------------
 f
(1 row)

ALTER SYSTEM SET pgsentinel_ash.track_idle_trans = true;
select pg_reload_conf();
 pg_reload_conf 
----------------
 t
(1 row)

begin;
\! sleep 3
commit;
select count(*) > 0 AS has_idle_data from pg_active_session_history where state  = 'idle in transaction';
 has_idle_data 
---------------
 t
(1 row)

-- Test privilege check
CREATE ROLE test_unprivileged LOGIN;
-- Check that unprivileged user sees redacted data for superuser's queries
SET ROLE test_unprivileged;
SELECT bool_or(query = '<insufficient privilege>') AS has_redacted_queries
FROM pg_active_session_history;
 has_redacted_queries 
----------------------
 t
(1 row)

RESET ROLE;
DROP ROLE test_unprivileged;
DROP EXTENSION pgsentinel;
DROP EXTENSION pg_stat_statements;
